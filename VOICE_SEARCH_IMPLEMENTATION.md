# üé§ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –ì–æ–ª–æ—Å–æ–≤–æ–≥–æ –ü–æ—à—É–∫—É (Voice Search)

## ‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ

### 1. –ë–µ–∫–µ–Ω–¥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

#### `utils/gemini_processor.py`
- ‚úÖ –î–æ–¥–∞–Ω–æ —Ñ—É–Ω–∫—Ü—ñ—é `transform_to_gmail_query(natural_language_text: str) -> str`
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —ñ—Å–Ω—É—é—á—É –ª–æ–≥—ñ–∫—É rate limiting (Redis sliding window)
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —ñ—Å–Ω—É—é—á—ñ retry –º–µ—Ö–∞–Ω—ñ–∑–º–∏ (`tenacity`)
- ‚úÖ System prompt –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–∏—Ä–æ–¥–Ω–æ—ó –º–æ–≤–∏ –≤ Gmail query —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
- ‚úÖ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó —Ç–∞ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—ó –º–æ–≤

**–ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:**
```python
query = transform_to_gmail_query("–∑–Ω–∞–π–¥–∏ –ª–∏—Å—Ç–∏ –≤—ñ–¥ –Ü–≤–∞–Ω–∞ –∑–∞ –≤—á–æ—Ä–∞")
# –ü–æ–≤–µ—Ä—Ç–∞—î: "from:ivan after:2025/12/11"
```

#### `utils/gmail_api.py`
- ‚úÖ –î–æ–¥–∞–Ω–æ —Ñ—É–Ω–∫—Ü—ñ—é `find_emails_by_query(service, query: str, max_results: int = 50) -> list`
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Gmail API `messages().list()` –∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î —Å–ø–∏—Å–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑ `id` —Ç–∞ `threadId`

#### `tasks.py`
- ‚úÖ –î–æ–¥–∞–Ω–æ —Ñ—É–Ω–∫—Ü—ñ—é `voice_search_task(credentials_json, search_text)`
- ‚úÖ –î–æ–¥–∞–Ω–æ `_voice_search_task_impl(credentials_json, search_text)`
- ‚úÖ –Ü–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–æ –∑ Flask app context –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –ë–î
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `transform_to_gmail_query` –¥–ª—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—É
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `find_emails_by_query` –¥–ª—è –ø–æ—à—É–∫—É
- ‚úÖ –û—Ç—Ä–∏–º—É—î –¥–µ—Ç–∞–ª—ñ –ª–∏—Å—Ç—ñ–≤ (subject, snippet) –¥–ª—è –ø–µ—Ä—à–∏—Ö 20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ—é

**–ü–æ–≤–µ—Ä—Ç–∞—î:**
```python
{
    'status': 'success',
    'query': '–∑–Ω–∞–π–¥–∏ –ª–∏—Å—Ç–∏ –≤—ñ–¥ –Ü–≤–∞–Ω–∞',
    'gmail_query': 'from:ivan',
    'total_found': 10,
    'results': [
        {
            'id': 'msg123',
            'threadId': 'thread123',
            'subject': 'Test Email',
            'snippet': 'Email content...'
        },
        ...
    ]
}
```

#### `server.py`
- ‚úÖ –î–æ–¥–∞–Ω–æ endpoint `/voice/search` (POST)
- ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
- ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è query –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
- ‚úÖ Enqueue task –¥–æ RQ —á–µ—Ä–µ–∑ `run_task_in_context`
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î `job_id` –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è

### 2. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

#### `templates/dashboard.html`
- ‚úÖ –î–æ–¥–∞–Ω–æ –∫–Ω–æ–ø–∫—É "üé§ –ì–æ–ª–æ—Å–æ–≤–∏–π –ü–æ—à—É–∫" –ø–æ—Ä—É—á –∑ "START SMART SORTING"
- ‚úÖ –î–æ–¥–∞–Ω–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–æ—à—É–∫—É
- ‚úÖ –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Web Speech API (`SpeechRecognition`)
- ‚úÖ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó –º–æ–≤–∏ (`lang: 'uk-UA'`)
- ‚úÖ –í—ñ–∑—É–∞–ª—å–Ω–∞ —ñ–Ω–¥–∏–∫–∞—Ü—ñ—è –∑–∞–ø–∏—Å—É (pulse animation)
- ‚úÖ –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–æ–≤–∞–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
- ‚úÖ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–ø–∏—Ç—É –Ω–∞ `/voice/search` endpoint
- ‚úÖ UI –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –ø–æ—à—É–∫—É

**–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –±—Ä–∞—É–∑–µ—Ä–Ω–∏–π Web Speech API (–Ω–µ –ø–æ—Ç—Ä–µ–±—É—î –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤)
- Continuous recognition (–±–µ–∑–ø–µ—Ä–µ—Ä–≤–Ω–∏–π –∑–∞–ø–∏—Å)
- Interim results (–ø–æ–ø–µ—Ä–µ–¥–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø—ñ–¥ —á–∞—Å –∑–∞–ø–∏—Å—É)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å—É –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö

### 3. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ —ñ—Å–Ω—É—é—á–æ—é —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ—é

- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —ñ—Å–Ω—É—é—á—É –ª–æ–≥—ñ–∫—É rate limiting (Gemini API)
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —ñ—Å–Ω—É—é—á—ñ retry –º–µ—Ö–∞–Ω—ñ–∑–º–∏ (`tenacity`)
- ‚úÖ –Ü–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–æ –∑ RQ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Flask app context –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –ë–î
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —ñ—Å–Ω—É—é—á—É —Å–∏—Å—Ç–µ–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (OAuth)

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
utils/gemini_processor.py
  ‚îî‚îÄ‚îÄ transform_to_gmail_query()  # AI —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è

utils/gmail_api.py
  ‚îî‚îÄ‚îÄ find_emails_by_query()      # Gmail API –ø–æ—à—É–∫

tasks.py
  ‚îî‚îÄ‚îÄ voice_search_task()         # RQ –∑–∞–¥–∞—á–∞
      ‚îî‚îÄ‚îÄ _voice_search_task_impl()

server.py
  ‚îî‚îÄ‚îÄ /voice/search (POST)        # Flask endpoint

templates/dashboard.html
  ‚îî‚îÄ‚îÄ Voice Search UI             # –§—Ä–æ–Ω—Ç–µ–Ω–¥ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      ‚îî‚îÄ‚îÄ Web Speech API
```

## üîÑ Workflow

1. **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î –∫–Ω–æ–ø–∫—É "–ì–æ–ª–æ—Å–æ–≤–∏–π –ü–æ—à—É–∫"**
   - –í—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
   - –ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è Web Speech API

2. **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≥–æ–≤–æ—Ä–∏—Ç—å –∑–∞–ø–∏—Ç**
   - –ë—Ä–∞—É–∑–µ—Ä —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±—É—î –≥–æ–ª–æ—Å –≤ —Ç–µ–∫—Å—Ç (Web Speech API)
   - –¢–µ–∫—Å—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ

3. **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑—É–ø–∏–Ω—è—î –∑–∞–ø–∏—Å**
   - –¢–µ–∫—Å—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –Ω–∞ `/voice/search`

4. **–ë–µ–∫–µ–Ω–¥ –æ–±—Ä–æ–±–ª—è—î –∑–∞–ø–∏—Ç**
   - Endpoint —Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ RQ —á–µ—Ä–≥—É
   - `voice_search_task` –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ:
     - –í–∏–∫–ª–∏–∫–∞—î `transform_to_gmail_query()` (Gemini AI)
     - –í–∏–∫–ª–∏–∫–∞—î `find_emails_by_query()` (Gmail API)
     - –ü–æ–≤–µ—Ä—Ç–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏

5. **–§—Ä–æ–Ω—Ç–µ–Ω–¥ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏**
   - (–ü–æ—Ç—Ä—ñ–±–Ω–æ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ polling –¥–ª—è RQ job status)
   - –ü–æ–∫–∞–∑—É—î –∑–Ω–∞–π–¥–µ–Ω—ñ –ª–∏—Å—Ç–∏

## üöÄ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –ü—Ä–∏–∫–ª–∞–¥–∏ –∑–∞–ø–∏—Ç—ñ–≤:

- "–∑–Ω–∞–π–¥–∏ –ª–∏—Å—Ç–∏ –≤—ñ–¥ –Ü–≤–∞–Ω–∞ –∑–∞ –≤—á–æ—Ä–∞" ‚Üí `from:ivan after:2025/12/11`
- "–Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω—ñ –ª–∏—Å—Ç–∏ –∑ –≤–∫–ª–∞–¥–µ–Ω–Ω—è–º–∏" ‚Üí `is:unread has:attachment`
- "–ª–∏—Å—Ç–∏ –ø—Ä–æ —ñ–Ω–≤–æ–π—Å–∏ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –º—ñ—Å—è—Ü—å" ‚Üí `subject:invoice after:2025/11/12`
- "–ª–∏—Å—Ç–∏ –≤—ñ–¥ –ü–µ—Ç—Ä–∞ –ø—Ä–æ –ø—Ä–æ–µ–∫—Ç" ‚Üí `from:petro subject:–ø—Ä–æ–µ–∫—Ç`

## üìù TODO (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

1. **–î–æ–¥–∞—Ç–∏ —Ç–µ—Å—Ç–∏** –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–æ—à—É–∫—É:
   - Unit tests –¥–ª—è `transform_to_gmail_query`
   - Unit tests –¥–ª—è `find_emails_by_query`
   - Integration tests –¥–ª—è `voice_search_task`
   - E2E tests –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ workflow

2. **–ü–æ–∫—Ä–∞—â–∏—Ç–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥:**
   - –î–æ–¥–∞—Ç–∏ polling –¥–ª—è RQ job status
   - –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –ø–æ—à—É–∫—É –≤ –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ
   - –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–Ω–∏—Ö —Å–∫–æ—Ä–æ—á–µ–Ω—å

3. **–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è:**
   - –ö–µ—à—É–≤–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –ø–æ—à—É–∫—É
   - –û–±–º–µ–∂–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
   - –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è –¥–ª—è –≤–µ–ª–∏–∫–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

4. **–õ–æ–≥—É–≤–∞–Ω–Ω—è:**
   - –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –ø–æ—à—É–∫—ñ–≤ –≤ –ë–î
   - –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤

## üîí –ë–µ–∑–ø–µ–∫–∞

- ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (OAuth)
- ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è –≤—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö
- ‚úÖ Rate limiting –¥–ª—è Gemini API
- ‚úÖ –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫

## üìö –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó

- **Web Speech API** - –±—Ä–∞—É–∑–µ—Ä–Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è –≥–æ–ª–æ—Å—É
- **Gemini AI** - —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–∏—Ä–æ–¥–Ω–æ—ó –º–æ–≤–∏ –≤ Gmail query
- **Gmail API** - –ø–æ—à—É–∫ –ª–∏—Å—Ç—ñ–≤
- **RQ (Redis Queue)** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –æ–±—Ä–æ–±–∫–∞
- **Flask** - –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫

---

**–î–∞—Ç–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó:** 2025-12-12  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Å–Ω–æ–≤–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ  
**–ü–æ–∫—Ä–∏—Ç—Ç—è —Ç–µ—Å—Ç–∞–º–∏:** ‚è≥ –ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏


