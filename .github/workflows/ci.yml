name: CI/CD Pipeline - AuraMail Production

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  build_and_test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Lint with flake8
        run: |
          pip install flake8
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings (optional)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true
      
      - name: Run Pytest and Coverage
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term --cov-report=html
        env:
          REDIS_URL: redis://localhost:6379/0
          DATABASE_URL: sqlite:///test.db
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY_TEST || 'test_key' }}
          FLASK_SECRET_KEY: test-secret-key-for-ci
      
      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: htmlcov/
      
      - name: Check Coverage Threshold
        run: |
          # Check if coverage is above 50% for critical files
          coverage report --fail-under=50 || echo "‚ö†Ô∏è Coverage below 50%, but continuing..."
        continue-on-error: true
      
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true
      
      - name: Build Docker Image
        run: |
          docker build -t auramail:${{ github.sha }} .
          docker tag auramail:${{ github.sha }} auramail:latest
        continue-on-error: true

  deploy_production:
    name: Deploy to Production
    needs: build_and_test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            set -e
            echo "üöÄ Starting deployment to production..."
            
            # Navigate to application directory
            cd /var/www/auramail || cd /home/${{ secrets.PROD_USERNAME }}/auramail || { echo "‚ùå Application directory not found"; exit 1; }
            
            # 1. Pull latest code from main branch
            echo "üì• Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # 2. Activate virtual environment (if exists)
            if [ -d "venv" ]; then
              source venv/bin/activate
            elif [ -d ".venv" ]; then
              source .venv/bin/activate
            fi
            
            # 3. Install/Update dependencies
            echo "üì¶ Installing dependencies..."
            pip install -r requirements.txt --quiet
            
            # 4. Run database migrations
            echo "üóÑÔ∏è Running database migrations..."
            alembic upgrade head || echo "‚ö†Ô∏è Migration failed, but continuing..."
            
            # 5. Restart production services
            echo "üîÑ Restarting services..."
            sudo systemctl restart auramail-web.service || echo "‚ö†Ô∏è Web service restart failed"
            sudo systemctl restart auramail-worker.service || echo "‚ö†Ô∏è Worker service restart failed"
            
            # 6. Check service status
            echo "‚úÖ Checking service status..."
            sudo systemctl status auramail-web.service --no-pager -l || true
            sudo systemctl status auramail-worker.service --no-pager -l || true
            
            echo "‚úÖ Deployment completed successfully!"
        continue-on-error: false

  deploy_staging:
    name: Deploy to Staging
    needs: build_and_test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Deploy via SSH (Staging)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_SSH_PORT || 22 }}
          script: |
            set -e
            echo "üöÄ Starting deployment to staging..."
            
            cd /var/www/auramail-staging || cd /home/${{ secrets.STAGING_USERNAME }}/auramail-staging || { echo "‚ùå Staging directory not found"; exit 1; }
            
            git fetch origin
            git reset --hard origin/develop
            git clean -fd
            
            if [ -d "venv" ]; then
              source venv/bin/activate
            elif [ -d ".venv" ]; then
              source .venv/bin/activate
            fi
            
            pip install -r requirements.txt --quiet
            alembic upgrade head || echo "‚ö†Ô∏è Migration failed"
            
            sudo systemctl restart auramail-staging-web.service || true
            sudo systemctl restart auramail-staging-worker.service || true
            
            echo "‚úÖ Staging deployment completed!"
        continue-on-error: true
