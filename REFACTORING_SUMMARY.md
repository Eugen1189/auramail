# üîÑ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ - –ü—ñ–¥—Å—É–º–æ–∫

## –ü—Ä–æ–±–ª–µ–º–∏, —è–∫—ñ –±—É–ª–∏ –≤–∏—Ä—ñ—à–µ–Ω—ñ

### 1. Circular Dependency
**–ü—Ä–æ–±–ª–µ–º–∞:** `tasks.py` —ñ–º–ø–æ—Ä—Ç—É–≤–∞–≤ `app` –∑ `server.py`, –∞ `server.py` —ñ–º–ø–æ—Ä—Ç—É–≤–∞–≤ `background_sort_task` –∑ `tasks.py`

**–†—ñ—à–µ–Ω–Ω—è:** –°—Ç–≤–æ—Ä–µ–Ω–æ `app_factory.py` –∑ —Ñ—É–Ω–∫—Ü—ñ—î—é `create_app()`, —è–∫–∞ —î —î–¥–∏–Ω–∏–º –¥–∂–µ—Ä–µ–ª–æ–º —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Flask app. –¢–µ–ø–µ—Ä –æ–±–∏–¥–≤–∞ –º–æ–¥—É–ª—ñ —ñ–º–ø–æ—Ä—Ç—É—é—Ç—å `create_app()` –±–µ–∑ circular dependency.

### 2. –ü—Ä–æ–±–ª–µ–º–∞ "no such table" —É Worker
**–ü—Ä–æ–±–ª–µ–º–∞:** Worker –Ω–µ –±–∞—á–∏–≤ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—É –ë–î, —Ç–æ–º—É —â–æ Flask app context –Ω–µ –±—É–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π

**–†—ñ—à–µ–Ω–Ω—è:** 
- Worker —Å—Ç–≤–æ—Ä—é—î Flask app —á–µ—Ä–µ–∑ `create_app()` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é –ë–î
- –°—Ç–≤–æ—Ä—é—î app context –¥–ª—è –∫–æ–∂–Ω–æ—ó –∑–∞–¥–∞—á—ñ –ø–µ—Ä–µ–¥ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º

### 3. –°–∫–ª–∞–¥–Ω–∞ –ª–æ–≥—ñ–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü—ñ—ó `create_app_for_worker()` —Ç–∞ `run_task_in_context()` —Å—Ç–≤–æ—Ä—é–≤–∞–ª–∏ –ø–ª—É—Ç–∞–Ω–∏–Ω—É

**–†—ñ—à–µ–Ω–Ω—è:** 
- –í–∏–¥–∞–ª–µ–Ω–æ –æ–±–∏–¥–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
- Worker –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è app context
- Tasks –ø—Ä–æ—Å—Ç–æ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è, –ø—Ä–∏–ø—É—Å–∫–∞—é—á–∏ —â–æ context –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π

## –ó–º—ñ–Ω–∏ –≤ —Ñ–∞–π–ª–∞—Ö

### –°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤—ñ —Ñ–∞–π–ª–∏:
- `app_factory.py` - Factory –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Flask app

### –ó–º—ñ–Ω–∏ –≤ `server.py`:
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `create_app()` –∑ `app_factory.py`
- –í–∏–¥–∞–ª–µ–Ω–æ –¥—É–±–ª—ñ–∫–∞—Ç –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó CORS/Talisman (—Ç–µ–ø–µ—Ä –≤ app_factory)
- –Ü–º–ø–æ—Ä—Ç tasks –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ —Ñ—É–Ω–∫—Ü—ñ—ó –º–∞—Ä—à—Ä—É—Ç—ñ–≤

### –ó–º—ñ–Ω–∏ –≤ `tasks.py`:
- –í–∏–¥–∞–ª–µ–Ω–æ `create_app_for_worker()` —Ç–∞ `run_task_in_context()`
- `background_sort_task()` —Ç–∞ `voice_search_task()` –ø—Ä–∏–π–º–∞—é—Ç—å –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π `flask_app` –ø–∞—Ä–∞–º–µ—Ç—Ä
- –§—É–Ω–∫—Ü—ñ—ó –ø—Ä–∏–ø—É—Å–∫–∞—é—Ç—å, —â–æ Flask app context –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π

### –ó–º—ñ–Ω–∏ –≤ `worker.py`:
- –°—Ç–≤–æ—Ä—é—î Flask app —á–µ—Ä–µ–∑ `create_app()` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é –ë–î
- –û–±–≥–æ—Ä—Ç–∞—î tasks –∑ Flask app context –ø–µ—Ä–µ–¥ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î monkey-patching –¥–ª—è –∑–∞–º—ñ–Ω–∏ tasks –Ω–∞ –æ–±–≥–æ—Ä–Ω—É—Ç—ñ –≤–µ—Ä—Å—ñ—ó

## –ü–µ—Ä–µ–≤–∞–≥–∏ –Ω–æ–≤–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É

1. ‚úÖ **–ù–µ–º–∞—î circular dependencies** - —á–∏—Å—Ç–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞
2. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∏–π DB context** - Worker –±–∞—á–∏—Ç—å —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—É –ë–î
3. ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –æ–¥–∏–Ω —Å–ø–æ—Å—ñ–± —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è app (app_factory)
4. ‚úÖ **–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å** - –º–µ–Ω—à–µ "–º–∞–≥—ñ—ó", –±—ñ–ª—å—à–µ —è–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—é
5. ‚úÖ **–ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ—Å—Ç—å** - –ª–µ–≥—à–µ –∑—Ä–æ–∑—É–º—ñ—Ç–∏ –ø–æ—Ç—ñ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

## –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î —Ç–µ–ø–µ—Ä

1. **Server startup:**
   - `server.py` –≤–∏–∫–ª–∏–∫–∞—î `create_app()` ‚Üí –æ—Ç—Ä–∏–º—É—î –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π app
   - –†–µ—î—Å—Ç—Ä—É—î routes
   - –ó–∞–ø—É—Å–∫–∞—î Flask —Å–µ—Ä–≤–µ—Ä

2. **Worker startup:**
   - `worker.py` –≤–∏–∫–ª–∏–∫–∞—î `create_app()` ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä—è—î –ë–î
   - –û–±–≥–æ—Ä—Ç–∞—î tasks –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è app context
   - –ó–∞–ø—É—Å–∫–∞—î RQ worker

3. **Task execution:**
   - RQ –æ—Ç—Ä–∏–º—É—î task
   - Worker –æ–±–≥–æ—Ä—Ç–∞—î –≤–∏–∫–ª–∏–∫ –≤ `app.app_context()`
   - Task –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º DB context
   - –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ SQLAlchemy

## –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

1. –ü—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ worker –∑ —Ä–µ–∞–ª—å–Ω–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏
2. –ü–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ –≤—Å—ñ —Ç–µ—Å—Ç–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç—å
3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —â–æ –ë–î –æ–ø–µ—Ä–∞—Ü—ñ—ó –ø—Ä–∞—Ü—é—é—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ

